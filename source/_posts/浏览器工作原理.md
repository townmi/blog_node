---
title: 浏览器工作原理
date: 2020-03-30 03:53:02
tags:
- JS
- CSS
categories:
- 前端
---

### 浏览器工作原理

#### 进程 (process) 和线程 (thread)

进程（process）和线程（thread）是操作系统的基本概念. 对于操作系统来说,一个任务就是一个进程，比如打开一个浏览器就是启动了一个浏览器进程,打开一个 Word 就启动了一个 Word 进程。
在一个进程内部,要同时做多件事,就需要同时运行多个“子任务”,我们把进程内的这些“子任务”称为线程
由于每个进程至少要做一件事,所以一个进程至少有一个线程。系统会给每个进程分配独立的内存,因此进程有它独立的资源。同一进程内的各个线程之间共享该进程的内存空间（包括代码段,数据集,堆等）。
*进程是 CPU 资源分配的最小单位（是能拥有资源和独立运行的最小单位）。*
*线程是 CPU 调度的最小单位（是建立在进程基础上的一次程序运行单位）。*

#### 浏览器的多进程架构

以Chrome为例，它由多个进程组成，每个进程协调组合来完成Chrome的功能，每个进程中又包含多个线程,一个进程内的多个线程也会协同工作,配合完成所在进程的职责。
Chrome 采用多进程架构,其顶层存在一个 Browser process 用以协调浏览器的其它进程。
这样做的优点
1. 由于默认 新开 一个 tab 页面 新建 一个进程,所以单个 tab 页面崩溃不会影响到整个浏览器。
2. 同样,第三方插件崩溃也不会影响到整个浏览器。
3. 多进程可以充分利用现代 CPU 多核的优势。
4. 方便使用沙盒模型隔离插件等进程,提高浏览器的稳定性。
同时缺点
1. 系统为浏览器新开的进程分配内存、CPU 等资源,所以内存和 CPU 的资源消耗也会更大。
2. 不过 Chrome 在内存释放方面做的不错,基本内存都是能很快释放掉给其他程序运行的。

#### 浏览器的主要进程和职责

![浏览器的主要进程](/uploads/20200330/1.png)
- 主进程 Browser Process
  负责浏览器界面的显示和交互,各个页面的管理,创建和销毁其他进程。网络的资源管理、下载等。
- 第三方插件进程 
  每类插件对应的一个进程，仅当使用该插件的时候才会创建
- GPU进程
  最多只有一个，用于3D渲染
- 渲染进程
  浏览器渲染进程(浏览器内核)，内部是多线程的，用来渲染页面，脚本执行，处理事件等等

#### 渲染进程(浏览器内核)解析

![浏览器内核线程](/uploads/20200330/2.png)
- GUI渲染线程
  负责渲染浏览器的界面，解析HTML、CSS构建DOM树和renderObejct树，布局，绘制等
  当界面需要*重绘*或者某些操作发生*回流*的时候，该进程就会工作
  注意，GUI线程和JS引擎线程是互斥的,当JS引擎线程执行的时候，GUI线程就会被冻结，GUI线程会被保留到一个队列中直到JS引擎线程空闲的时候，才会被执行
- JS引擎线程
  JS引擎线程，用来解析执行JS脚本,例如常见的V8引擎
  JS引擎一直等待着任务队列中的任务，然后一个个执行掉，一个渲染进程只会有一个JS引擎线程
  因为JS引擎线程和GUI线程是互斥的，所以JS引擎执行时间太长，会导致页面渲染延迟，卡
- 事件处理线程
  事件处理线程是来控制事件循环的，当JS引擎执行到setTimeOut、鼠标事件、http请求，会将任务添加到事件线程中.
  当任务符合触发的条件时，事件线程会把该任务添加到事件队列的末尾，等待JS引擎的处理
  因为JS引擎是单线程的，所以任务队列里面的事件都在等待JS引擎的处理
- 定时器线程
  setInterval 与 setTimeout 所在线程
  W3C 在 HTML 标准中规定 setTimeOut 低于 4ms 算 4ms
- http线程
  XHR产生请求就会创建这个线程
  检查有状态变更，如果有回调函数,就会将这个回调放入事件队列，等待JS引擎的执行

#### 渲染进程(浏览器内核)的工作流程
我们来看下渲染进程是处理页面的。

![渲染进程(浏览器内核)的工作流程](/uploads/20200330/3.png)
1. 解析 HTML 文件,构建 DOM 树,同时浏览器主进程负责下载 CSS 文件
2. CSS 文件下载完成, 解析 CSS 文件成树形的数据结构, 然后结合 DOM 树合并成 RenderObject 树
3. 布局 RenderObject 树 （Layout/reflow）,负责 RenderObject 树中的元素的尺寸,位置等计算
4. 绘制 RenderObject 树 （paint）,绘制页面的像素信息
5. 浏览器主进程将默认的图层和复合图层交给 GPU 进程,GPU 进程再将各个图层合成（composite）,最后显示出页面
