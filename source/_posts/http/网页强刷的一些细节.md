---
title: 网页强刷的一些细节
date: 2021-02-05 19:37:38
tags:
- Nginx
- JS
categories:
- 前端
---

### 网页强刷的一些细节
今天有同事说到，我都已经`CTRL+F5`了，为什么页面上的图片还是旧的，那么我么来看看到底发生了什么？

<!-- more -->

### 刷新和强刷的区别

`F5`(刷新) 有可能得到的是旧的页面，即使页面在服务器已经更新，因为，刷新有可能从缓存读取。但是`CTRL+F5`会强制清楚本地浏览器的缓存，如果服务器页面更新，你会得到最新的页面

那浏览器是如何实现的呢，如下图:

![F5|CTRL+F5](/uploads/20210205/1.png)

总结下来就是，浏览器在强刷的时候，浏览器在请求页面的时候，在请求头添加了一些参数，来实现清楚本地缓存，来得到最新页面的。
其中必究重要的参数就是：
* `cache-control: no-cache`
* `pragma: no-cache`

那为什么还是会有人遇到我强刷了页面，但是有些图片还是旧的情况呢？

### `ajax`是罪魁祸首

仔细研究发现，页面中的部分图片是通过`ajax`来获取的，这就直接造成强刷失败的情况。
因为强刷的缓存机制并不适用于`ajax`, 我们需要手动给ajax添加请求头来清楚缓存。也就是上面的参数
```js
  fetch("https://gitee.com/bd_share/static/api/css/share_style1_32.png", {cache: 'no-cache', headers: { pragma: 'no-cache'}})
```

### 如何避免这些问题

首先，现代的前端工程，基本都是通过编译版本、`hash`等技术来给刷新资源。用户执行普通的刷新也可以得到最新的页面。
当然通过`ajax`获取动态数据和提交数据，正常的服务器开发不会使用缓存，即使服务端使用了缓存技术，客户端也可以在ajax中添加参数来更新数据。
如果是通过`ajax`获取静态数据或者静态资源，我们尽量在请求链接中添加版本号或者时间戳来避免缓存。