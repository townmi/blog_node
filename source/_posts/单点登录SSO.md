---
title: 单点登录SSO
date: 2020-06-01 03:53:02
tags:
- JS
categories:
- 前端
---

### 单点登录SSO
单点登录（Single Sign On），简称为`SSO`，是目前比较流行的企业业务整合的解决方案之一。`SSO`的定义是在多个应用系统中，用户只需要登录一次就可以访问所有相互信任的应用系统。

<!-- more -->

#### 简介

`SSO`一般都需要一个独立的认证中心（passport），子系统的登录均得通过passport，子系统本身将不参与登录操作，当一个系统成功登录以后，passport将会颁发一个令牌给各个子系统，子系统可以拿着令牌会获取各自的受保护资源，为了减少频繁认证，各个子系统在被passport授权以后，会建立一个局部会话，在一定时间内可以无需再次向passport发起认证
> 举个例子，比如淘宝、天猫都属于阿里旗下的产品，当用户登录淘宝后，再打开天猫，系统便自动帮用户登录了天猫，这种现象背后就是用单点登录实现的。

### 单点登录的流程

#### 登录

![登录流程](/uploads/20200601/1.png)

1. 用户访问系统1的受保护资源，系统1发现用户未登录，跳转至`sso`认证中心，并将自己的地址作为参数
2. `sso`认证中心发现用户未登录，将用户引导至登录页面
3. 用户输入用户名密码提交登录申请
4. `sso`认证中心校验用户信息，创建用户与`sso`认证中心之间的会话，称为全局会话，同时创建授权令牌
5. `sso`认证中心带着令牌跳转会最初的请求地址（系统1）
6. 系统1拿到令牌，去`sso`认证中心校验令牌是否有效
7. `sso`认证中心校验令牌，返回有效，注册系统1
8. 系统1使用该令牌创建与用户的会话，称为局部会话，返回受保护资源
9. 用户访问系统2的受保护资源
10. 系统2发现用户未登录，跳转至`sso`认证中心，并将自己的地址作为参数
11. `sso`认证中心发现用户已登录，跳转回系统2的地址，并附上令牌
12. 系统2拿到令牌，去`sso`认证中心校验令牌是否有效
13. `sso`认证中心校验令牌，返回有效，注册系统2
14. 系统2使用该令牌创建与用户的局部会话，返回受保护资源
用户登录成功之后，会与`sso`认证中心及各个子系统建立会话，用户与`sso`认证中心建立的会话称为全局会话，用户与各个子系统建立的会话称为局部会话，局部会话建立之后，用户访问子系统受保护资源将不再通过sso认证中心，全局会话与局部会话有如下约束关系
- 局部会话存在，全局会话一定存在
- 全局会话存在，局部会话不一定存在
- 全局会话销毁，局部会话必须销毁

#### 注销
sso认证中心一直监听全局会话的状态，一旦全局会话销毁，监听器将通知所有注册系统执行注销操作

![注销流程](/uploads/20200601/2.png)

1. 用户向系统1发起注销请求
2. 系统1根据用户与系统1建立的会话id拿到令牌，向`sso`认证中心发起注销请求
3. `sso`认证中心校验令牌有效，销毁全局会话，同时取出所有用此令牌注册的系统地址
4. `sso`认证中心向所有注册系统发起注销请求
5. 各注册系统接收`sso`认证中心的注销请求，销毁局部会话
6. `sso`认证中心引导用户至登录页面


#### 什么是CAS
`CAS`是`Central Authentication Service`的缩写，中央认证服务，一种独立开放指令协议。`CAS`是`Yale`大学发起的一个开源项目，旨在为Web应用系统提供一种可靠的单点登录方法。`CAS`包含两个部分：`CAS Server`和`CAS Client`。`CAS Server`需要独立部署，主要负责对用户的认证工作；`CAS Client`负责处理对客户端受保护资源的访问请求，需要登录时，重定向到`CAS Server`。
CAS 最基本的协议过程：
![CAS 最基本的协议过程](/uploads/20200601/3.png)

`CAS Client`与受保护的客户端应用部署在一起，以`Filter`方式保护受保护的资源。对于访问受保护资源的每个`Web`请求，`CAS Client`会分析该请求的`Http`请求中是否包含`Service Ticket`，如果没有，则说明当前用户尚未登录，于是将请求重定向到指定好的`CAS Server`登录地址，并传递`Service`（也就是要访问的目的资源地址），以便登录成功过后转回该地址。用户在第3步中输入认证信息，如果登录成功，`CAS Server`随机产生一个相当长度、唯一、不可伪造的`Service Ticket`，并缓存以待将来验证，之后系统自动重定向到`Service`所在地址，并为客户端浏览器设置一个`Ticket Granted Cookie（TGC）`，`CAS Client`在拿到`Service`和新产生的`Ticket`过后，在第 5，6 步中与`CAS Server`进行身份核实，以确保 `Service Ticket`的合法性。
在该协议中，所有与`CAS`的交互均采用`SSL`协议，确保，`ST`和`TGC`的安全性。协议工作过程中会有 2 次重定向的过程，但是`CAS Client`与`CAS Server`之间进行`Ticket`验证的过程对于用户是透明的。
另外，`CAS`协议中还提供了`Proxy`（代理）模式，以适应更加高级、复杂的应用场景，具体介绍可以参考`CAS`官方网站上的相关文档。


#### 什么是OAuth2

`OAuth`（开放授权）是一个开放标准，允许用户让第三方应用访问该用户在某一网站上存储的私密的资源（如照片，视频，联系人列表），而无需将用户名和密码提供给第三方应用。
通俗说，`OAuth`就是一种授权的协议，只要授权方和被授权方遵守这个协议去写代码提供服务，那双方就是实现了`OAuth`模式。
详细说就是，`OAuth`在"客户端"与"服务提供商"之间，设置了一个授权层（authorization layer）。"客户端"不能直接登录"服务提供商"，只能登录授权层，以此将用户与客户端区分开来。"客户端"登录授权层所用的令牌（`token`），与用户的密码不同。用户可以在登录的时候，指定授权层令牌的权限范围和有效期。"客户端"登录授权层以后，"服务提供商"根据令牌的权限范围和有效期，向"客户端"开放用户储存的资料。
`OAuth2`是`OAuth1.0`的下一个版本，`OAuth2`关注客户端开发者的简易性，同时为Web应用，桌面应用和手机，和起居室设备提供专门的认证流程。原先的`OAuth`，会发行一个 有效期非常长的token(典型的是一年有效期或者无有效期限制)，在`OAuth 2.0`中，server将发行一个短有效期的`access token`和长生命期的`refresh token`。这将允许客户端无需用户再次操作而获取一个新的`access token`，并且也限制了`access token`的有效期

#### CAS和OAuth2区别

- `CAS`的单点登录时保障客户端的用户资源的安全,`OAuth2`则是保障服务端的用户资源的安全;
- `CAS`客户端要获取的最终信息是，这个用户到底有没有权限访问我（`CAS`客户端）的资源;`oauth2`获取的最终信息是，我（`oauth2`服务提供方）的用户的资源到底能不能让你（`oauth2`的客户端）访问;
- `CAS`的单点登录，资源都在客户端这边，不在`CAS`的服务器那一方。用户在给`CAS`服务端提供了用户名密码后，作为`CAS`客户端并不知道这件事。随便给客户端个`ST`，那么客户端是不能确定这个`ST`是用户伪造还是真的有效，所以要拿着这个`ST`去服务端再问一下，这个用户给我的是有效的`ST`还是无效的`ST`，是有效的我才能让这个用户访问。
- `OAuth2`认证，资源都在`OAuth2`服务提供者那一方，客户端是想索取用户的资源。所以在最安全的模式下，用户授权之后，服务端并不能直接返回`token`，通过重定向送给客户端，因为这个`token`有可能被黑客截获，如果黑客截获了这个`token`，那用户的资源也就暴露在这个黑客之下了。于是聪明的服务端发送了一个认证`code`给客户端（通过重定向），客户端在后台，通过https的方式，用这个`code`，以及另一串客户端和服务端预先商量好的密码，才能获取到`token`和刷新`token`，这个过程是非常安全的。如果黑客截获了`code`，他没有那串预先商量好的密码，他也是无法获取`token`的。这样`oauth2`就能保证请求资源这件事，是用户同意的，客户端也是被认可的，可以放心的把资源发给这个客户端了。
- `CAS`登录和`OAuth2`在流程上的最大区别就是，通过`ST`或者`code`去认证的时候，需不需要预先商量好的密码。

#### 总结CAS和OAuth2区别

**CAS：授权服务器，被授权客户端**

1. 授权服务器（一个）保存了全局的一份`session`，客户端（多个）各自保存自己的`session`；
2. 客户端登录时判断自己的`session`是否已登录，若未登录，则（告诉浏览器）重定向到授权服务器（参数带上自己的地址，用于回调）；
3. 授权服务器判断全局的`session`是否已登录，若未登录则定向到登录页面，提示用户登录，登录成功后，授权服务器重定向到客户端（参数带上`ticket`【一个凭证号】）；
4. 客户端收到`ticket`后，请求服务器获取用户信息；
5. 服务器同意客户端授权后，服务端保存用户信息至全局`session`，客户端将用户保存至本地`session`

**OAuth2:主系统，授权系统（给主系统授权用的，也可以跟主系统是同一个系统），第三方系统**

1. 第三方系统需要使用主系统的资源，第三方重定向到授权系统;
2. 根据不同的授权方式，授权系统提示用户授权;
3. 用户授权后，授权系统返回一个授权凭证（`accessToken`）给第三方系统【`accessToken`是有有效期的】;
4. 第三方使用`accessToken`访问主系统资源【`accessToken`失效后，第三方需重新请求授权系统，以获取新的`accessToken`】

转载[https://juejin.im/post/5b73c71fe51d45666016655a](https://juejin.im/post/5b73c71fe51d45666016655a)
