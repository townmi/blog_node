<!doctype html>
<html lang="en">
<head>
	<% include head_meta.ejs %>
	<title><%= title %></title>
	<link rel="stylesheet" type="text/css" href="../css/reset.css">
	<link rel="stylesheet" type="text/css" href="../css/monokai.css">
</head>
<body>

	<% include head.ejs %>

	<div class="ui_edit clear" id="js_center">
		<div class="ui_edit_in fl" id="js_article">
			<div id="control">
				<% if(data[0]){ %>
				<ul class="ui_edit_tags">
					<li>
						<label for="title">标题:</label>
						<input type="text" class="ui_base_text" placeholder="请输入标题" id="title" value=<%= data[0].title %>>
					</li>
					<li>
						<label for="categories">分类:</label>
						<input type="text" class="ui_base_text" placeholder="请输入分类" id="categories" value=<%= data[0].categories %>>
					</li>
					<li>
						<label for="music">音乐:</label>
						<input type="text" class="ui_base_text" placeholder="请输入背景音乐" id="music" value=<%= data[0].music %>>
					</li>
				</ul>
				<div class="ui_edit_content">
					<label for="body">内容:</label>
					<pre id="body" style="height: 680px;"><%= data[0].body %></pre>
				</div>
				<p class="ui_edit_submit">
					<a href="javascript:;" class="js_change_update" key=<%= data[0].id %>>提交</a>
				</p>
				<% }else{ %>
				<ul class="ui_edit_tags">
					<li>
						<label for="title">标题:</label>
						<input type="text" class="ui_base_text" placeholder="请输入标题" id="title">
					</li>
					<li>
						<label for="categories">分类:</label>
						<input type="text" class="ui_base_text" placeholder="请输入分类" id="categories">
					</li>
					<li>
						<label for="music">音乐:</label>
						<input type="text" class="ui_base_text" placeholder="请输入背景音乐" id="music">
					</li>
				</ul>
				<div class="ui_edit_content">
					<label for="body">内容:</label>
					<!-- <textarea placeholder="请输入内容" id="body" rows="20" cols="50"spellcheck="false" autocomplete="off"></textarea> -->
					<pre id="body" style="height: 680px;"></pre>
				</div>
				<p class="ui_edit_submit">
					<a href="javascript:;" class="js_edit_update">提交</a>
				</p>
				<% } %>
				
			</div>
		</div>
		<div class="ui_edit_out fr" id="js_edit_show">
			
		</div>
	</div>

	<% include foot.ejs %>

</body>
<script type="text/javascript" src="../js/src/jquery.js"></script>
<script type="text/javascript" src="../js/src/showdown.js"></script>
<script type="text/javascript" src="../js/src/extensions/prettify.js"></script>
<script type="text/javascript" src="../js/src/highlight.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.1.8/ace.js"></script>
<script type="text/javascript">

	$(function(){

		var converter = new Showdown.converter({ extensions: ['prettify'] });

		ace.require("ace/ext/chromevox");

		var val = $("#body").html();

		$("#js_edit_show").html( converter.makeHtml( val) );

		$("code").each(function (i, block){
			hljs.highlightBlock(block);
		});

	    var editor = ace.edit("body");

	    editor.setTheme("ace/theme/monokai");
	    editor.setValue(val);
		editor.setHighlightActiveLine(false);

		editor.getSession().on('change', function(e) {

			$("#js_edit_show").html( converter.makeHtml( editor.getValue() ) );

	    	$("code").each(function (i, block){
				hljs.highlightBlock(block);
			});

		});

		$("#control .js_edit_update").on("click", function(){

			if(!$("#title").val() || !$("#categories").val() || !$("#music").val() || !editor.getValue()) return;

			$.ajax({
				type: "post",
				url: "/edit",
				data: {
					"title" : $("#title").val(),
					"categories": $("#categories").val(),
					"music": $("#music").val(),
					"body": editor.getValue()
				},
				dataType: "json",
				success: function (data){
					if(data.target){
						window.location.href = window.location.origin;
					}
				},
				error: function (msg){
				}
			})
		});

		$("#control .js_change_update").on("click", function(){

			if(!$("#title").val() || !$("#categories").val() || !$("#music").val() || !editor.getValue()) return;

			var key = $(this).attr("key");

			$.ajax({
				type: "post",
				url: "/change",
				data: {
					"title" : $("#title").val(),
					"categories": $("#categories").val(),
					"music": $("#music").val(),
					"body": editor.getValue(),
					"key": key
				},
				dataType: "json",
				success: function (data){
					if(data.target){
						window.location.href = window.location.origin;
					}
				},
				error: function (msg){ 	
				}
			})
		});

		// 登出
		$("#logout").on('click', function(){
			$.ajax({
				type: "post",
				url: "/logout",
				data: {
				},
				dataType: "json",
				success: function (data){
					if(!data.login){
						window.location.reload();
					}
				},
				error: function (msg){
					console.log(msg)
				}
			})
		});
	});
</script>
<script type="text/javascript">
	$(function (){

    	var TOBOOTOM =  $(window).height() - $("body").height();

    	var w1 = $("#js_center").height();

    	if(TOBOOTOM>0){

    		$("#js_center").css({
    			"height" : TOBOOTOM+w1
    		});

    	}

	})
</script>
</html>